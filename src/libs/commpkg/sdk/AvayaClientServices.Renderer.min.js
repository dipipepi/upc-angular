!function(t,h){var d=jQuery;!function(t){"use strict";var e,i;(e=t).Renderer=e.Renderer||{},(i=t).Renderer.Konva=i.Renderer.Konva||{}}(AvayaClientServices),function(t){"use strict";function e(){this._contentSharing=h}e.prototype={init:function(t,i){(this._contentSharing=t).addOnCursorReceivedCallback(function(t,e){this.showCursor(e)}.bind(this)),t.addOnContentSharingStartedCallback(function(t,e){this.start(i)}.bind(this)),t.addOnContentSharingEndedCallback(function(t,e){this.stop()}.bind(this)),t.addOnContentSharingPausedCallback(function(t,e){this.pause()}.bind(this)),t.addOnContentSharingResumedCallback(function(t,e){this.unpause()}.bind(this)),t.addOnFrameReceivedCallback(function(t,e){this.drawFrame(e)}.bind(this)),t.addOnFrameChangedCallback(function(t,e){this.drawFrame(e)}.bind(this))},showCursor:function(t){},start:function(){},stop:function(){},pause:function(){},unpause:function(){},drawFrame:function(t){}},t.Renderer.ContentSharingRenderer=e}(AvayaClientServices),function(i){"use strict";function t(){this._state=i.Renderer.Konva.KonvaContentSharingState.STOPPED,this._width=0,this._height=0,this._cursor=h,Konva.pixelRatio=1,this._drawingLayer=new Konva.FastLayer,this._zoomLayer=new Konva.FastLayer,this._mainLayer=new Konva.FastLayer,this._cursorLayer=new Konva.FastLayer,this._pauseLayer=new Konva.FastLayer,this._drawingStage=h,this._zoomStage=h,this._screenSharingBg=h,this._interval=-1,this._scale=1}(t.prototype=Object.create(i.Renderer.ContentSharingRenderer.prototype)).getWidth=function(){return this._width},t.prototype.getHeight=function(){return this._height},t.prototype.drawFrame=function(t){this._width!==t.getWidth()&&0<t.getWidth()&&(this._drawingStage.setWidth(t.getWidth()),this._zoomStage.setWidth(t.getWidth()*this._scale),this._width=t.getWidth(),this._state===i.Renderer.Konva.KonvaContentSharingState.PAUSED&&this._redrawPauseLayer()),this._height!==t.getHeight()&&0<t.getHeight()&&(this._drawingStage.setHeight(t.getHeight()),this._zoomStage.setHeight(t.getHeight()*this._scale),this._height=t.getHeight(),this._state===i.Renderer.Konva.KonvaContentSharingState.PAUSED&&this._redrawPauseLayer());var e=t.getBitmaps().map(this._generateImage.bind(this));d.when.apply(this,e).then(this._drawReceivedFrame.bind(this))},t.prototype._drawReceivedFrame=function(){if(this._state!==i.Renderer.Konva.KonvaContentSharingState.STOPPED){this._drawingLayer.draw();var t=this._getImageFromLayer(this._drawingLayer);this._mainLayer.removeChildren(),this._mainLayer.add(t),this._mainLayer.draw(),t=this._getImageFromLayer(this._mainLayer),this._drawingLayer.removeChildren(),this._drawingLayer.add(t),t=this._getImageFromLayer(this._mainLayer),this._zoomLayer.removeChildren(),this._zoomLayer.add(t),this._zoomLayer.draw()}},t.prototype._getImageFromLayer=function(t){var e=t.getCanvas();return new Konva.Image({x:0,y:0,image:e._canvas})},t.prototype._onImageLoaded=function(t,e,i){var n=new Konva.Image({x:t.getXOffset(),y:t.getYOffset(),image:e,width:t.getWidth(),height:t.getHeight()});this._drawingLayer.add(n),i.resolve(),window.URL.revokeObjectURL(e.src)},t.prototype._generateImage=function(t){var e=new Image,i=d.Deferred();return e.onload=function(){this._onImageLoaded(t,e,i)}.bind(this),e.src=t.getBlobData(),i.promise()},t.prototype.showCursor=function(t){var e=new Konva.Tween({node:this._cursor,duration:.1,easing:Konva.Easings.EaseIn,x:t.getX(),y:t.getY(),onFinish:function(){e.destroy()}});e.play()},t.prototype.stop=function(){this._mainLayer.destroyChildren(),this._drawingLayer.destroyChildren(),this._zoomLayer.destroyChildren(),this._cursorLayer.destroyChildren(),this._pauseLayer.destroyChildren(),this._width=0,this._height=0,this._drawingStage&&(this._drawingStage.destroyChildren(),this._drawingStage.setWidth(0),this._drawingStage.setHeight(0),this._drawingStage.draw(),this._drawingStage.destroy(),this._drawingStage=h),this._zoomStage&&(this._zoomStage.destroyChildren(),this._zoomStage.setWidth(0),this._zoomStage.setHeight(0),this._zoomStage.draw(),this._zoomStage.destroy(),this._zoomStage=h),d(this._screenSharingBg).remove(),this._screenSharingBg=h,this._state=i.Renderer.Konva.KonvaContentSharingState.STOPPED},t.prototype.start=function(t){var e=document.createElement("div");e.setAttribute("id",t+"-bg"),e.classList.add("hide"),this._screenSharingBg=e,d("#"+t).parent().append(e),this._drawingStage=new Konva.Stage({container:t+"-bg",width:this._width,height:this._height}),this._zoomStage=new Konva.Stage({container:t,width:this._width,height:this._height}),this._zoomStage.scale({x:this._scale,y:this._scale}),this._drawingStage.add(this._drawingLayer),this._drawingStage.add(this._mainLayer),this._zoomStage.add(this._zoomLayer),this._zoomStage.add(this._cursorLayer),this._zoomStage.add(this._pauseLayer),this._cursor=new Konva.Circle({x:-10,y:-10,radius:5,fill:"#EF5353"}),this._cursorLayer.add(this._cursor),this._state=i.Renderer.Konva.KonvaContentSharingState.STARTED,this._mainLayer.destroyChildren(),this._zoomLayer.destroyChildren(),this._drawingStage.draw(),this._zoomStage.draw()},t.prototype.pause=function(){this._state=i.Renderer.Konva.KonvaContentSharingState.PAUSED,0<this._drawingStage.getWidth()?this._redrawPauseLayer():this._contentSharing.isSharingApplicationWindow()||this._contentSharing.isSharingFullScreen()||this._contentSharing.isSharingApplicationWindow()===h||(this._width=800,this._height=600,this._drawingStage.setWidth(this._width),this._drawingStage.setHeight(this._height),this._zoomStage.setWidth(this._width*this._scale),this._zoomStage.setHeight(this._height*this._scale),this._redrawPauseLayer())},t.prototype._redrawPauseLayer=function(){this._pauseLayer.removeChildren();var t=new Konva.Rect({x:0,y:0,opacity:.1,width:this._drawingStage.getWidth(),height:this._drawingStage.getHeight(),fill:"#00897b"});this._pauseLayer.add(t);var e=new Konva.Rect({x:this._drawingStage.getWidth()/2-20-10,y:(this._drawingStage.getHeight()-80)/2,width:20,height:80,fill:"#00897b"});this._pauseLayer.add(e);var i=new Konva.Rect({x:this._drawingStage.getWidth()/2+10,y:(this._drawingStage.getHeight()-80)/2,width:20,height:80,fill:"#00897b"});this._pauseLayer.add(i),this._zoomStage.draw()},t.prototype.unpause=function(){this._state=i.Renderer.Konva.KonvaContentSharingState.STARTED,this._pauseLayer.removeChildren(),this._zoomStage.draw()},t.prototype.zoom=function(t){if(t<=0)throw new Error("Scale cannot be lower than 0.");t>=Number.POSITIVE_INFINITY||(this._scale=t,this._zoomStage.height(this._height*this._scale),this._zoomStage.width(this._width*this._scale),this._zoomStage.scale({x:this._scale,y:this._scale}),this._zoomStage.draw())},t.prototype.autoFit=function(t,e){var i;return i=this._width*e/this._height<t?e/this._height:t/this._width,this.zoom(i),i},i.Renderer.Konva.KonvaContentSharingRenderer=t}(AvayaClientServices),function(t){"use strict";AvayaClientServices.Renderer.Konva.KonvaContentSharingState={STARTED:"STARTED",STOPPED:"STOPPED",PAUSED:"PAUSED"}}(),function(){"use strict";function t(){}t.prototype={convertRectangle:function(t){var e=!!t.attrs.fill,i=this._colorHexToInt(e?t.attrs.fill:t.attrs.stroke),n=t.attrs.strokeWidth||0,a=new AvayaClientServices.Services.Collaboration.Shape("",e,!0,i,void 0,n);return a.addMovePoint(new AvayaClientServices.Services.Collaboration.Point(t.attrs.x,t.attrs.y)),a.addLinePoint(new AvayaClientServices.Services.Collaboration.Point(t.attrs.x+t.attrs.width,t.attrs.y)),a.addLinePoint(new AvayaClientServices.Services.Collaboration.Point(t.attrs.x+t.attrs.width,t.attrs.y+t.attrs.height)),a.addLinePoint(new AvayaClientServices.Services.Collaboration.Point(t.attrs.x,t.attrs.y+t.attrs.height)),a.addLinePoint(new AvayaClientServices.Services.Collaboration.Point(t.attrs.x,t.attrs.y)),a.finishDrawing(),a},convertEllipse:function(t){var e=new AvayaClientServices.Services.Collaboration.Point(t.attrs.x-t.attrs.radiusX,t.attrs.y-t.attrs.radiusY),i=new AvayaClientServices.Services.Collaboration.Point(t.attrs.x+t.attrs.radiusX,t.attrs.y+t.attrs.radiusY),n=!!t.attrs.fill,a=this._colorHexToInt(n?t.attrs.fill:t.attrs.stroke),o=t.attrs.strokeWidth||0;return new AvayaClientServices.Services.Collaboration.Circle(e,i,"",n,!0,a,void 0,o)},convertText:function(t){var e=t.attrs.text,i=t.attrs.fontSize,n=this._colorHexToInt(t.attrs.fill),a=new AvayaClientServices.Services.Collaboration.WhiteboardText(e,i,"",!0,!0,n);return a.setPosition(new AvayaClientServices.Services.Collaboration.Point(t.attrs.x,t.attrs.y)),a},convertLine:function(t){var e=this._colorHexToInt(t.attrs.stroke),i=t.attrs.strokeWidth||0,n=new AvayaClientServices.Services.Collaboration.Shape("",!1,!0,e,void 0,i);return n.addMovePoint(new AvayaClientServices.Services.Collaboration.Point(t.attrs.points[0],t.attrs.points[1])),n.addLinePoint(new AvayaClientServices.Services.Collaboration.Point(t.attrs.points[2],t.attrs.points[3])),n.finishDrawing(),n},convertPolygon:function(t,e){var i=!!t.attrs.fill,n=this._colorHexToInt(i?t.attrs.fill:t.attrs.stroke),a=t.attrs.strokeWidth||0,o=100*t.attrs.opacity,r=new AvayaClientServices.Services.Collaboration.Shape("",i,!0,n,o,a);r.addMovePoint(new AvayaClientServices.Services.Collaboration.Point(t._modelStart.x,t._modelStart.y));for(var s=0;s<t._modelRelativePoints.length;s++){var h=t._modelRelativePoints[s];0!==h.x&&0!==h.y&&r.addLinePoint(new AvayaClientServices.Services.Collaboration.Point(t._modelStart.x+h.x,t._modelStart.y+h.y))}return e&&r.finishDrawing(),r},_colorHexToInt:function(t){return"#"===t[0]?parseInt("0x".concat(t.slice(1))):parseInt("0x".concat(t))}},AvayaClientServices.Renderer.Konva.KonvaWhiteboardConverter=t}(),function(r){"use strict";function t(){r.Services.Collaboration.WhiteboardRenderer.call(this),this._width=800,this._height=600,this._scale=1,this._drawingStage=h,this._drawingLayer=h,this._canvas=h,this._mode=r.Services.Collaboration.WhiteboardToolModes.STROKE,this._color="#211e1e",this._strokeWidth=6,this._whiteboardConverter=new r.Renderer.Konva.KonvaWhiteboardConverter,this._whiteboardTools=new r.Renderer.Konva.KonvaWhiteboardTools(this),this._tool=this._whiteboardTools[r.Services.Collaboration.WhiteboardToolTypes.RECTANGLE],this._isDrawing=!1,this._fontSize=19,this._annotatedShape=h,this._inputExists=!1,this._curWin=window}(t.prototype=Object.create(r.Services.Collaboration.WhiteboardRenderer.prototype)).getWidth=function(){return this._width},t.prototype.getHeight=function(){return this._height},t.prototype.start=function(t){this._setupWhiteboard(t),this._canvas=document.getElementById(t).getElementsByClassName("konvajs-content")[0].getElementsByTagName("canvas")[0],this._canvas.onmousedown=function(t){if(!this._whiteboard.getDrawingCapability().isAllowed)return r.Base.Logger.warn(r.Base.LoggerTags.COLLABORATION_SERVICE,"It is not possible to use any whiteboard tool since whiteboard is not available at the moment."),!1;switch(this._tool.type){case r.Services.Collaboration.WhiteboardToolTypes.SELECTION:return;case r.Services.Collaboration.WhiteboardToolTypes.RECTANGLE:case r.Services.Collaboration.WhiteboardToolTypes.CIRCLE:return void this._dragTool(t);case r.Services.Collaboration.WhiteboardToolTypes.MARKER:case r.Services.Collaboration.WhiteboardToolTypes.PEN:return void this._liveTool(t);case r.Services.Collaboration.WhiteboardToolTypes.LINE:return void this._dragTool(t);case r.Services.Collaboration.WhiteboardToolTypes.STAMP:return void this._stampTool(t);case r.Services.Collaboration.WhiteboardToolTypes.TEXT:return void this._textTool(t);case r.Services.Collaboration.WhiteboardToolTypes.DELETE:return void this._deleteShape(t);case r.Services.Collaboration.WhiteboardToolTypes.CLEAR:return}}.bind(this)},t.prototype.end=function(t){this._drawingLayer&&(this._canvas.onmousedown=h,this._drawingLayer.destroyChildren(),this._drawingStage.destroyChildren(),this._drawingLayer.destroy(),this._drawingStage.destroy(),document.getElementById(t).innerHTML="",this._drawingLayer=h,this._drawingStage=h)},t.prototype.drawShape=function(e){if(this._drawingLayer){var t;if(this._drawingLayer.children.filter(function(t){return t.id===e.getId()}).length){var i=this._whiteboard.getActiveSurface().getShapes()[e.getId()];return void(r.Base.Utils.isDefined(i._ownerDisplayName)&&""!==i._ownerDisplayName||(i._ownerDisplayName=e.getOwnerDisplayName()))}if(e instanceof r.Services.Collaboration.Shape)t=this._createShape(e);else if(e instanceof r.Services.Collaboration.Circle)t=this._createCircle(e);else{if(!(e instanceof r.Services.Collaboration.WhiteboardText))return;t=this._createText(e)}this._drawingLayer.add(t),this._drawingLayer.draw()}},t.prototype.removeShape=function(t){var e=this._getKonvaShape(t);e&&(e.destroy(),this._drawingLayer.draw())},t.prototype._deleteShape=function(t){var e=this._drawingLayer.getIntersection({x:t.offsetX,y:t.offsetY});if(null!==e){var i=this._getSDKShape(e);if(i.isMine())return this.removeShape(i),this._whiteboard.getActiveSurface().removeShape(i)}var n=d.Deferred();return n.reject(),n.promise()},t.prototype.updateShape=function(n){var t,e,a=this._getKonvaShape(n);n.getId()!==a.id&&(a.id=n.getId()),a instanceof Konva.Ellipse&&r.Base.Utils.isDefined(n.getTranslation())?(t=a.initX+n.getTranslation().getX(),e=a.initY+n.getTranslation().getY()):a instanceof Konva.Text&&r.Base.Utils.isDefined(n.getPosition())?(t=n.getPosition().getX()+n.getTranslation().getX(),e=n.getPosition().getY()+n.getTranslation().getY()):a instanceof Konva.Shape&&(r.Base.Utils.isDefined(n.getTranslation())?e=a instanceof Konva.Rect?(t=n.getPoints()[0].point.getX()+n.getTranslation().getX(),n.getPoints()[0].point.getY()+n.getTranslation().getY()):(t=n.getTranslation().getX(),n.getTranslation().getY()):a.attrs.sceneFunc=function(t){t.beginPath();for(var e=n.getPoints(),i=0;i<e.length;i++)e[i].isMove?t.moveTo(e[i].point.getX(),e[i].point.getY()):t.lineTo(e[i].point.getX(),e[i].point.getY());t.fillStrokeShape(a)}.bind(this)),r.Base.Utils.isDefined(t)&&r.Base.Utils.isDefined(e)&&a.position({x:t,y:e}),this._drawingLayer.draw()},t.prototype.clearContent=function(){if(r.Base.Utils.isDefined(this._drawingLayer)){for(var t=this._drawingLayer.children.length-1;0<=t;t--)this._drawingLayer.children[t].destroy();this._drawingLayer.draw()}},t.prototype.setTool=function(t,e){r.Base.Logger.debug(r.Renderer.LoggerTags.KONVA_WHITEBOARD_RENDERER,"Tool set: ",t,e),this._tool.type===r.Services.Collaboration.WhiteboardToolTypes.SELECTION&&this._drawingLayer&&this._unsetDraggable(),this._tool.type===r.Services.Collaboration.WhiteboardToolTypes.TEXT&&this._destructTextTool(),this._tool=this._whiteboardTools[t],e&&this._tool.modes[e]&&(this._mode=e),r.Base.Utils.isDefined(this._canvas)&&t!==r.Services.Collaboration.WhiteboardToolTypes.SELECTION&&t!==r.Services.Collaboration.WhiteboardToolTypes.DELETE&&(this._canvas.onmousemove=h,this._canvas.onmouseout=h,r.Base.Utils.isDefined(this._annotatedShape)&&(this._onShowShapeAnnotationCallbacks.fire(),this._annotatedShape=h)),!r.Base.Utils.isDefined(this._canvas)||t!==r.Services.Collaboration.WhiteboardToolTypes.SELECTION&&t!==r.Services.Collaboration.WhiteboardToolTypes.DELETE||(this._canvas.onmousemove=function(t){var e=this._drawingLayer.getIntersection({x:t.offsetX,y:t.offsetY});if(null!==e&&!r.Base.Utils.isDefined(this._annotatedShape)||null!==e&&r.Base.Utils.isDefined(this._annotatedShape)&&e._id!==this._annotatedShape._id){var i=this._getSDKShape(e);this._onShowShapeAnnotationCallbacks.fire(i),this._annotatedShape=e}else null===e&&r.Base.Utils.isDefined(this._annotatedShape)&&(this._onShowShapeAnnotationCallbacks.fire(),this._annotatedShape=h)}.bind(this),this._canvas.onmouseout=function(t){r.Base.Utils.isDefined(this._annotatedShape)&&(this._onShowShapeAnnotationCallbacks.fire(),this._annotatedShape=h)}.bind(this)),t===r.Services.Collaboration.WhiteboardToolTypes.SELECTION&&this._setDraggable(),t===r.Services.Collaboration.WhiteboardToolTypes.CLEAR&&this._clear()},t.prototype._destructTextTool=function(){var t=this._canvas.parentNode.querySelector("#"+this._getTextInputId());t&&(t.value?this._renderText(h,t):t.parentNode.removeChild(t))},t.prototype._getTextInputId=function(){return this._whiteboardTools[r.Services.Collaboration.WhiteboardToolTypes.TEXT]._getElementId()},t.prototype._renderText=function(t,e){var i=this._tool.endInput(t,this._canvas,e,this._scale);i.fill(this._color),i.fontSize(r.Services.Collaboration.WhiteboardTextSizes[this._mode]),i.fontStyle("bold"),this._drawingLayer.add(i),this._drawingLayer.draw(),this._convertAndAddShape(i,this._tool.name)},t.prototype.setColor=function(t){r.Base.Logger.debug(r.Renderer.LoggerTags.KONVA_WHITEBOARD_RENDERER,"Color set: ",t),this._color=t},t.prototype.zoom=function(t){if(t<=0)throw new Error("Scale cannot be lower than 0.");t>=Number.POSITIVE_INFINITY||(this._scale=t,this._drawingLayer.scale({x:this._scale,y:this._scale}),this._drawingLayer.draw(),this._drawingStage.height(this._height*this._scale),this._drawingStage.width(this._width*this._scale))},t.prototype.resubscribeWinEvents=function(){var t=this._canvas.ownerDocument.defaultView;t&&this._curWin!==t&&(Konva.DD._endDragBefore&&(this._curWin.removeEventListener("mouseup",Konva.DD._endDragBefore,!0),this._curWin.removeEventListener("touchend",Konva.DD._endDragBefore,!0),t.addEventListener("mouseup",Konva.DD._endDragBefore,!0),t.addEventListener("touchend",Konva.DD._endDragBefore,!0)),Konva.DD._drag&&(this._curWin.removeEventListener("mousemove",Konva.DD._drag),this._curWin.removeEventListener("touchmove",Konva.DD._drag),t.addEventListener("mousemove",Konva.DD._drag),t.addEventListener("touchmove",Konva.DD._drag)),Konva.DD._endDragAfter&&(this._curWin.removeEventListener("mouseup",Konva.DD._endDragAfter,!1),this._curWin.removeEventListener("touchend",Konva.DD._endDragAfter,!1),t.addEventListener("mouseup",Konva.DD._endDragAfter,!1),t.addEventListener("touchend",Konva.DD._endDragAfter,!1)),this._drawingStage&&this._drawingStage._bindContentEvents&&this._drawingStage._bindContentEvents(),this._curWin=t)},t.prototype.autoFit=function(t,e){var i;return i=this._width*e/this._height<t?e/this._height:t/this._width,this.zoom(i),i},t.prototype._textTool=function(t){var e=this._canvas.parentNode.querySelector("#"+this._getTextInputId());e?this._inputExists&&this._renderText(t,e):(this._tool.startInput(t,this._canvas,this._mode,this._scale),this._inputExists=!0)},t.prototype._dragTool=function(t){var e;this._isDrawing=!0,e=this._tool.startFunction(t,this._mode,this._scale);var i=function(t){this._isDrawing=!1,this._tool.endFunction(t),this._clearMouseEvents(),e.isMine=!0,this._convertAndAddShape(e,this._tool.name)}.bind(this);this._canvas.onmouseup=function(t){i(t)}.bind(this),this._canvas.onmouseleave=function(t){i(t)}.bind(this)},t.prototype._liveTool=function(t){var i;this._isDrawing=!0,i=this._tool.startFunction(t,this._scale);var n=this._whiteboardConverter.convertPolygon(i,!1),e=function(t){this._isDrawing=!1,this._tool.endFunction(t),this._clearMouseEvents(),i.isMine=!0,n.isFinished()||n.finishDrawing().done(function(t){this._updateShapeId(i,t)}.bind(this))}.bind(this);return this._canvas.onmousemove=function(t){this._tool.drawFunction(t,i);var e=new r.Services.Collaboration.Point(t.offsetX/this._scale,t.offsetY/this._scale);!function(t,e){if(1<t.length){var i=t.length-2,n=t.length-1;(function(t,e,i){var n={};n.gradient=(t.point.getY()-e.point.getY())/(t.point.getX()-e.point.getX()),n.interceptY=t.point.getY()-n.gradient*t.point.getX();var a=i.point.getY()===n.gradient*i.point.getX()+n.interceptY,o=t.point.getX()===e.point.getX()&&e.point.getX()===i.point.getX()||t.point.getY()===e.point.getY()&&e.point.getY()===i.point.getY();return a&&(1===n.gradient||-1===n.gradient)||o})(t[i],t[n],e)&&t.splice(n,1)}}(n.getPoints(),{point:e}),n.addLinePoint(e)}.bind(this),this._canvas.onmouseup=function(t){e(t)}.bind(this),this._canvas.onmouseleave=function(t){e(t)}.bind(this),this._whiteboard.getActiveSurface().addShape(n).done(function(t){this._updateShapeId(i,t)}.bind(this))},t.prototype._stampTool=function(t){var e;this._isDrawing=!0,(e=this._tool.drawFunction(t,this._scale)).isMine=!0,this._isDrawing=!1,this._convertAndAddShape(e,this._tool.name)},t.prototype._clear=function(){return this.clearContent(),this._whiteboard.getActiveSurface().clearContent()},t.prototype._createShape=function(t){var n=t.getPoints(),e=new Konva.Shape({fill:t.isFilled()?r.Base.Utils.colorIntToHex(t.getColor()):h,stroke:t.isFilled()?h:r.Base.Utils.colorIntToHex(t.getColor()),strokeWidth:t.isFilled()?h:t.getWidth(),lineCap:"round",lineJoin:"round",opacity:t.getAlpha()/100,sceneFunc:function(t){t.beginPath();for(var e,i=0;i<n.length;i++)(e=n[i]).isMove?t.moveTo(e.point.getX(),e.point.getY()):t.lineTo(e.point.getX(),e.point.getY());t.fillStrokeShape(this)}});return r.Base.Utils.isDefined(t.getTranslation())&&e.position({x:t.getTranslation().getX(),y:t.getTranslation().getY()}),this._addCommonData(t,e)},t.prototype._moveShape=function(t,e){var i=this._getSDKShape(t),n=e.newPositionX-e.selectionX,a=e.newPositionY-e.selectionY,o=i.getTranslation();r.Base.Utils.isDefined(o)?i.setTranslation(new r.Services.Collaboration.Point(o.getX()+n,o.getY()+a)):i.setTranslation(new r.Services.Collaboration.Point(n,a)),this._whiteboard.getActiveSurface().updateShape(i)},t.prototype._createCircle=function(t){var e=new Konva.Ellipse({x:t.getTopLeft().getX()+(t.getBottomRight().getX()-t.getTopLeft().getX())/2,y:t.getTopLeft().getY()+(t.getBottomRight().getY()-t.getTopLeft().getY())/2,radius:{x:(t.getBottomRight().getX()-t.getTopLeft().getX())/2,y:(t.getBottomRight().getY()-t.getTopLeft().getY())/2},fill:t.isFilled()?r.Base.Utils.colorIntToHex(t.getColor()):h,stroke:t.isFilled()?h:r.Base.Utils.colorIntToHex(t.getColor()),strokeWidth:t.isFilled()?h:t.getWidth()});return e.initX=e.attrs.x,e.initY=e.attrs.y,r.Base.Utils.isDefined(t.getTranslation())&&e.position({x:e.initX+t.getTranslation().getX(),y:e.initY+t.getTranslation().getY()}),this._addCommonData(t,e)},t.prototype._createText=function(t){var e=new Konva.Text({x:t.getPosition().getX(),y:t.getPosition().getY(),fill:r.Base.Utils.colorIntToHex(t.getColor()),text:t.getContent(),fontSize:t.getFontSize(),fontFamily:"Arial",fontStyle:"bold",lineHeight:1.25});return r.Base.Utils.isDefined(t.getTranslation())&&e.position({x:t.getPosition().getX()+t.getTranslation().getX(),y:t.getPosition().getY()+t.getTranslation().getY()}),this._addCommonData(t,e)},t.prototype._addCommonData=function(t,e){return e.id=t.getId(),e.ownerDisplayName=t.getOwnerDisplayName(),e.status=t.getStatus(),e.isMine=t.isMine(),e},t.prototype._setupWhiteboard=function(t){this._drawingStage&&this.end(t),this._drawingStage=new Konva.Stage({container:t,width:this._width,height:this._height}),this._drawingLayer=new Konva.Layer,this._drawingStage.add(this._drawingLayer),this.zoom(this._scale)},t.prototype._convertAndAddShape=function(e){var t;if(e instanceof Konva.Rect)return t=this._whiteboardConverter.convertRectangle(e),this._whiteboard.getActiveSurface().addShape(t).done(function(t){this._updateShapeId(e,t)}.bind(this));if(e instanceof Konva.Ellipse)return t=this._whiteboardConverter.convertEllipse(e),this._whiteboard.getActiveSurface().addCircle(t).done(function(t){this._updateShapeId(e,t)}.bind(this));if(e instanceof Konva.Line)return t=this._whiteboardConverter.convertLine(e),this._whiteboard.getActiveSurface().addShape(t).done(function(t){this._updateShapeId(e,t)}.bind(this));if(e instanceof Konva.Text)return t=this._whiteboardConverter.convertText(e),this._whiteboard.getActiveSurface().addText(t).done(function(t){this._updateShapeId(e,t)}.bind(this));if(e instanceof Konva.Shape){return t=this._whiteboardConverter.convertPolygon(e,!0),this._whiteboard.getActiveSurface().addShape(t).done(function(t){this._updateShapeId(e,t)}.bind(this))}},t.prototype._getKonvaShape=function(t){if(this._drawingLayer&&this._drawingLayer.children)for(var e=0;e<this._drawingLayer.children.length;e++)if(this._drawingLayer.children[e].id===t.getId()||this._drawingLayer.children[e].id===t._tempId)return this._drawingLayer.children[e]},t.prototype._getSDKShape=function(t){return this._whiteboard.getActiveSurface().getShapes()[t.id]},t.prototype._updateShapeId=function(t,e){t.id=e},t.prototype._setDraggable=function(){var t,e=this._drawingLayer.children;for(t=0;t<e.length;t++)e[t].isMine&&e[t].draggable(!0);this._drawingLayer.on("dragstart",function(t){this._tool.dragStart(t,this._scale)}.bind(this)),this._drawingLayer.on("dragend",function(t){this._tool.dragEnd(t,this._scale)}.bind(this)),this._drawingLayer.draw()},t.prototype._unsetDraggable=function(){var t,e=this._drawingLayer.children;for(t=0;t<e.length;t++)e[t].isMine&&e[t].draggable(!1);this._drawingLayer.off("dragstart"),this._drawingLayer.off("dragend"),this._drawingLayer.draw()},t.prototype._clearMouseEvents=function(){this._canvas.onmouseup=h,this._canvas.onmouseleave=h},r.Renderer.Konva.KonvaWhiteboardRenderer=t}(AvayaClientServices),function(){"use strict";var C=1.25;function t(m){AvayaClientServices.Services.Collaboration.WhiteboardTools.call(this);var t=this[AvayaClientServices.Services.Collaboration.WhiteboardToolTypes.LINE],e=this[AvayaClientServices.Services.Collaboration.WhiteboardToolTypes.RECTANGLE],i=this[AvayaClientServices.Services.Collaboration.WhiteboardToolTypes.CIRCLE],n=this[AvayaClientServices.Services.Collaboration.WhiteboardToolTypes.STAMP],a=this[AvayaClientServices.Services.Collaboration.WhiteboardToolTypes.SELECTION],o=this[AvayaClientServices.Services.Collaboration.WhiteboardToolTypes.TEXT],r=this[AvayaClientServices.Services.Collaboration.WhiteboardToolTypes.MARKER],s=this[AvayaClientServices.Services.Collaboration.WhiteboardToolTypes.PEN];r.startFunction=function(t,i){var n=new Konva.Shape({stroke:m._color,strokeWidth:12,lineCap:"round",lineJoin:"round",opacity:.6,sceneFunc:function(t){t.beginPath();var e=0;for(t.moveTo(n._modelStart.x,n._modelStart.y);e<n._modelRelativePoints.length;e++)t.lineTo(n._modelRelativePoints[e].x/i,n._modelRelativePoints[e].y/i);t.fillStrokeShape(this)}});return n._modelStart={x:t.offsetX/i,y:t.offsetY/i},n._modelRelativePoints=[],m._drawingLayer.add(n),m._drawingLayer.draw(),n}.bind(this),r.drawFunction=function(t,e){e._modelRelativePoints.push({x:t.offsetX,y:t.offsetY}),m._drawingLayer.draw(),m._drawingStage.draw()},r.endFunction=function(){m._canvas.onmousemove=h}.bind(this),s.startFunction=function(t,i){var n=new Konva.Shape({stroke:m._color,strokeWidth:4,lineCap:"round",lineJoin:"round",opacity:1,sceneFunc:function(t){t.beginPath();var e=0;for(t.moveTo(n._modelStart.x,n._modelStart.y);e<n._modelRelativePoints.length;e++)t.lineTo(n._modelRelativePoints[e].x/i,n._modelRelativePoints[e].y/i);t.fillStrokeShape(this)}});return n._modelStart={x:t.offsetX/i,y:t.offsetY/i},n._modelRelativePoints=[],m._drawingLayer.add(n),m._drawingLayer.draw(),n}.bind(this),s.drawFunction=function(t,e){e._modelRelativePoints.push({x:t.offsetX,y:t.offsetY}),m._drawingLayer.draw(),m._drawingStage.draw()},s.endFunction=function(){m._canvas.onmousemove=h}.bind(this),o._getElementId=function(){return"canvasTextInput"},o.endInput=function(t,e,i,n){var a=parseInt(i.style.fontSize.replace("px","")),o=0,r=0;if(getComputedStyle){var s=parseInt(getComputedStyle(i).borderBottomWidth),h=parseInt(getComputedStyle(i).paddingLeft),d=parseInt(getComputedStyle(i).paddingTop);s&&(r+=s,o+=s),h&&(o+=h),d&&(r+=d)}var l=new Konva.Text({x:parseInt(i.style.left)/n+o,y:parseInt(i.style.top)/n+r,text:i.value,fontFamily:"Arial",lineHeight:C,fontSize:a});return l.isMine=!0,l.fontStyle("bold"),m._inputExists=!1,i.parentNode.removeChild(i),l},o.startInput=function(t,v,e,i){var u=v.getBoundingClientRect().width,p=v.getBoundingClientRect().height,f=document.createElement("textarea"),g=20,n=1,c=(t.offsetY,t.offsetX),y=AvayaClientServices.Services.Collaboration.WhiteboardTextSizes[e]*i,_=!1;function S(t){if(n=1,t.split("").forEach(function(t,e,i){"\n"!==t||(n+=1)}),f.setAttribute("rows",n),AvayaClientServices.Base.Utils.getBrowserType()===AvayaClientServices.Base.BrowserType.IE){var e=f.id,i=d("#"+e);i.length&&i.height(C*n*y)}}function w(){var t=f.clientHeight,e=f.clientWidth,i=f.offsetTop,n=f.offsetLeft;t+i>v.clientHeight&&(f.style.top=v.clientHeight-t+"px"),e+n>v.clientWidth&&(f.style.left=v.clientWidth-e+"px")}function b(t){var e=document.createElement("span");return e.style.cssText="font-weight:bold; top:400px; left:300px; line-height: normal; visibility:hidden; borderRadius: 1px; position: absolute; border: 1px  solid rgb(106, 105, 105); margin: 0; white-space: pre; padding:2px; display: inline-block; font-size:"+y+"px; font-family:'Arial'",e.innerHTML=t,document.body.appendChild(e),setTimeout(function(){document.body.removeChild(e)},100),e.getBoundingClientRect().width}f.setAttribute("id",this._getElementId()),f.setAttribute("rows",n),f.style.cssText="z-Index: 101; outline: 0; font-family: 'Arial'; font-weight:bold; font-size:"+y+"px; position: absolute; top:"+t.offsetY.toString()+"px; left:"+t.offsetX.toString()+"px; overflow: hidden; width:"+g+"px; line-height:"+C+"; height: auto; margin:0; border: 1px solid rgb(106, 105, 105); background: white; border-radius: 1px; margin-top: -2px; white-space: pre; color:"+m._color,v.parentNode.appendChild(f),setTimeout(function(){f.focus()}),w(),f.addEventListener("keypress",function(t){var e=t.target.value,i=e.length,n=t.keyCode,a=String.fromCharCode(t.keyCode),o=f.clientHeight,r=v.clientWidth;if(v.clientHeight<=o+y){if(13===n)return t.preventDefault(),!1;var s,h=t.target.selectionStart,d=0,l=e.split("");l.splice(h,0,a);for(var g=l.join(""),c=h;c<i+1;c++)if("\n"===g[c]){s=c;break}for(var _=h;0<=_;_--)if("\n"===g[_]){d=_;break}if(s&&(s+=1),r<b(g.slice(d+1,s)))return t.preventDefault(),!1}w()}),f.addEventListener("input",function(t){var e=t.target.value;3500<e.length&&(t.target.value=e.slice(0,3500),e=t.target.value);var i=e.length,n=t.target.value.charCodeAt(i-1);if("insertFromPaste"===t.inputType||_){var a=t.target.value.split("\n"),o=Math.round(p/(y*C));a.length>o&&(a=a.slice(0,o)),e=function(t){for(var e=t.join("\n").split(""),i=0,n=Math.round(p/(y*C)),a=0;a<t.length;a++){var o=t[a];if(b(o)>u)for(var r=Math.ceil(b(o)/u),s=0,h=0;h<r;h++){for(var d=o.slice(s,s+151),l=0;l<3500&&b(d)>u;l++)d=d.substring(0,d.length-1);var g=d.split("");-1<d.indexOf(" ")&&s+d.length!==o.length?(e.splice(g.lastIndexOf(" ")+i+s,1,"\n"),s=s+g.lastIndexOf(" ")+1):s+d.length!==o.length&&(e.splice(g.length+i+s,0,"\n"),s=g.length+s)}i+=o.length+1}var c=e.join(""),_=c.split("\n");return _.length>n&&(c=_.slice(0,n).join("\n")),c}(a),t.target.value=e}if(10!==n||"insertFromPaste"===t.inputType||_)if((g=b(e))<u){if(f.style.width=g+"px",f.getBoundingClientRect().left+g>v.getBoundingClientRect().right){var r=f.getBoundingClientRect().left+g-v.getBoundingClientRect().right;c-=r,f.style.left=c+"px"}S(t.target.value)}else{f.style.left=0,f.style.width=u+"px";var s=t.target.value.split("\n").slice(-1)[0],h=b(s),d=s.indexOf(" "),l=e.split("");u<h&&(t.target.value=(-1<d?l.splice(l.lastIndexOf(" "),1,"\n"):l.splice(-1,0,"\n"),l.join("")),S(t.target.value))}else 1===i?t.target.value="":S(t.target.value);_=!1,w()}),f.addEventListener("paste",function(){_=!0})},a.dragStart=function(t,e){this._clickData={x:t.evt.pageX/e,y:t.evt.pageY/e}},a.dragEnd=function(t,e){if(this._clickData){m._moveShape(t.target,{selectionX:this._clickData.x,selectionY:this._clickData.y,newPositionX:t.evt.pageX/e,newPositionY:t.evt.pageY/e});this._clickData=h}},t.startFunction=function(t,e,i){var n={x:t.offsetX/i,y:t.offsetY/i},a={x:t.offsetX/i,y:t.offsetY/i},o=new Konva.Line({points:[n.x,n.y,a.x,a.y],stroke:m._color,strokeWidth:AvayaClientServices.Services.Collaboration.WhiteboardLineWidths[e],lineCap:"round",lineJoin:"round"});return m._drawingLayer.add(o),m._drawingLayer.draw(),m._canvas.onmousemove=function(t){a.x=t.offsetX/i,a.y=t.offsetY/i,o.attrs.points=[n.x,n.y,a.x,a.y],m._drawingLayer.draw(),m._drawingStage.draw()}.bind(this),o}.bind(this),t.endFunction=function(t){m._canvas.onmousemove=h}.bind(this),e.startFunction=function(t,e,i){var n;return"FILLED"===e?n=new Konva.Rect({x:t.offsetX/i,y:t.offsetY/i,width:1,height:1,fill:m._color}):"STROKE"===e&&(n=new Konva.Rect({x:t.offsetX/i,y:t.offsetY/i,width:AvayaClientServices.Services.Collaboration.WhiteboardLineWidths.LARGE,height:1,lineCap:"round",lineJoin:"round",stroke:m._color,strokeWidth:m._strokeWidth})),m._drawingLayer.add(n),m._drawingLayer.draw(),m._canvas.onmousemove=function(t){n.width(t.offsetX/i-n.attrs.x),n.height(t.offsetY/i-n.attrs.y),m._drawingLayer.draw(),m._drawingStage.draw()}.bind(this),n}.bind(this),e.endFunction=function(t){m._canvas.onmousemove=h}.bind(this),i.startFunction=function(t,e,i){var n,a=t.offsetX/i,o=t.offsetY/i,r={x:t.offsetX/i,y:t.offsetY/i};return"FILLED"===e?n=new Konva.Ellipse({x:a+(r.x-a)/2,y:o+(r.y-o)/2,radius:{x:Math.abs(r.x-a)/2,y:Math.abs(r.y-o)/2},fill:m._color}):"STROKE"===e&&(n=new Konva.Ellipse({x:a+(r.x-a)/2,y:o+(r.y-o)/2,radius:{x:Math.abs(r.x-a)/2,y:Math.abs(r.y-o)/2},stroke:m._color,strokeWidth:m._strokeWidth})),m._drawingLayer.add(n),m._drawingLayer.draw(),m._canvas.onmousemove=function(t){r.x=t.offsetX/i,r.y=t.offsetY/i,n.radius({x:Math.abs(r.x-a)/2,y:Math.abs(r.y-o)/2}),n.x(a+(r.x-a)/2),n.y(o+(r.y-o)/2),n.initX=a+(r.x-a)/2,n.initY=o+(r.y-o)/2,m._drawingLayer.draw(),m._drawingStage.draw()}.bind(this),n}.bind(this),i.endFunction=function(t){m._canvas.onmousemove=h}.bind(this),n.drawFunction=function(t,e){var i={x:t.offsetX/e,y:t.offsetY/e},n=[{x:0,y:0},{x:-10,y:-10},{x:-42,y:-10},{x:-42,y:10},{x:-10,y:10}],a=new Konva.Shape({fill:m._color,sceneFunc:function(t){t.beginPath(),t.moveTo(i.x,i.y);for(var e=1;e<n.length;e++)t.lineTo(i.x+n[e].x,i.y+n[e].y);t.closePath(),t.fillStrokeShape(this)}});return a._modelStart=i,a._modelRelativePoints=n,m._drawingLayer.add(a),m._drawingLayer.draw(),m._drawingStage.draw(),a}.bind(this)}t.prototype=Object.create(AvayaClientServices.Services.Collaboration.WhiteboardTools.prototype),AvayaClientServices.Renderer.Konva.KonvaWhiteboardTools=t}(),function(t){"use strict";AvayaClientServices.Renderer.LoggerTags={KONVA_WHITEBOARD_RENDERER:"KonvaWhiteboardRenderer"}}(),AvayaClientServices.Base.Library.Service.jQuery.addOnVersionChangedCallback(function(t){d=t})}();